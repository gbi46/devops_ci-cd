# Define an upstream — this points to the Django (Gunicorn) container.
# "web" here must match the service name from docker-compose.yml
upstream django {
    server web:8000;
}

server {
    # Listen on port 80 (standard HTTP)
    listen 80;
    server_name _;  # The underscore means “catch all” hostnames

    # ------------------------------
    # STATIC FILES
    # ------------------------------
    # Serve static files directly from the static volume
    location /static/ {
        alias /static/;          # Maps /static URL path to /static directory in the container
        access_log off;          # Disable access log for performance
        expires 30d;             # Cache static files for 30 days
    }

    # ------------------------------
    # MEDIA FILES (user uploads)
    # ------------------------------
    location /media/ {
        alias /media/;           # Maps /media URL path to /media directory in the container
        access_log off;
        expires 30d;
    }

    # ------------------------------
    # DJANGO / GUNICORN APP
    # ------------------------------
    location / {
        proxy_pass http://django;  # Send all other requests to the Django app
        proxy_set_header Host $host;                     # Preserve original host header
        proxy_set_header X-Real-IP $remote_addr;         # Forward real client IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Chain of proxies
        proxy_set_header X-Forwarded-Proto $scheme;      # Pass the original protocol (HTTP/HTTPS)
    }

    # ------------------------------
    # GENERAL SETTINGS
    # ------------------------------
    client_max_body_size 25m;  # Limit upload size (adjust as needed)
}
